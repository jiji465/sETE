<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Fiscal | Avant Garde Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Brand Palette */
            --brand-dark-blue: #001D3D;
            --brand-corporate-blue: #0057FF; /* New Primary */
            --brand-gold: #D4A657; /* Accent */
            --brand-danger: #ef4444;
            --brand-success: #22c55e;
            --brand-warning: #f59e0b;
            --brand-purple: #8b5cf6;
            --brand-pink: #ec4899;

            /* Light Theme - REFINED */
            --background: #f7f8fc;
            --card-bg: #ffffff;
            --subtle-bg: #f0f2f8;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --border-focus: var(--brand-corporate-blue);

            /* Mapped Variables - REFINED */
            --primary-fg: var(--brand-corporate-blue);
            --primary-bg: color-mix(in srgb, var(--brand-corporate-blue) 10%, transparent);
            --primary-bg-hover: color-mix(in srgb, var(--brand-corporate-blue) 20%, transparent);
            --primary-light: var(--brand-gold);
            --primary-dark: #0045cc;
            --danger: var(--brand-danger);
            --success: var(--brand-success);
            --warning: var(--brand-warning);

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
            --border-radius: 0.875rem; /* Softer radius */
        }

        /* Dark Theme Variables */
        html.dark-theme {
            --background: #0a0e13;
            --card-bg: #141920;
            --subtle-bg: #1c2128;
            --text-primary: #e6edf3;
            --text-secondary: #909da9;
            --text-tertiary: #6e7681;
            --border-color: #2a3038;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.15);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.18), 0 2px 4px -2px rgb(0 0 0 / 0.18);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.2);
        }

        /* General Body Styles */
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background); 
            color: var(--text-primary); 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            background-image: linear-gradient(180deg, var(--background) 0%, var(--subtle-bg) 100vh);
            background-repeat: no-repeat;
        }
        #main-content-wrapper {
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        ::selection { background-color: var(--primary-bg); }

        /* Animations */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slide-in-fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .table-row.animate-in { opacity: 0; animation: slide-in-fade 0.4s ease-out forwards; }

        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        .skeleton-loader {
            position: relative;
            overflow: hidden;
            background-color: var(--subtle-bg);
            border-radius: 0.5rem;
        }
        .skeleton-loader::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--border-color) 50%, transparent), transparent);
            animation: shimmer 1.5s infinite;
        }
        main.dashboard-loading {
            pointer-events: none;
        }
        
        /* Layout: Header & Sidebar */
        .app-header { 
            background-color: transparent;
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Nav Tabs */
        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .nav-tab:hover {
            color: var(--primary-fg);
            background-color: var(--primary-bg-hover);
        }
        .nav-tab.active {
            color: var(--primary-fg);
            background-color: var(--primary-bg);
        }

        .sidebar { 
            background-color: var(--card-bg); 
            border-right: 1px solid var(--border-color); 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .logo-full,
        .sidebar.collapsed .sidebar-text {
            opacity: 0;
            width: 0;
            visibility: hidden;
            white-space: nowrap;
        }
        .sidebar .sidebar-text { transition: opacity 0.2s ease, width 0.2s ease, visibility 0.2s ease; }
        .sidebar.collapsed .logo-collapsed { display: flex; }
        .sidebar.collapsed .sidebar-label { justify-content: center; }
        .sidebar.collapsed #sidebar-company-list { padding-right: 0; }
        .sidebar.collapsed #sidebar-toggle-btn { justify-content: center; }

        .sidebar-label:hover { background-color: var(--primary-bg); }

        /* Cards */
        .kpi-card, .chart-card, .content-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.25s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .kpi-card {
             padding: 1.25rem;
             border-top: 4px solid var(--kpi-border-color, var(--primary-fg));
        }
        .kpi-card::after {
            content: '';
            position: absolute;
            top: -80px; right: -80px;
            width: 200px; height: 200px;
            background: radial-gradient(circle, color-mix(in srgb, var(--kpi-border-color) 15%, transparent) 0%, transparent 70%);
            opacity: 0.5;
            transition: all 0.4s ease;
            pointer-events: none;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-lg);
            border-color: var(--kpi-border-color);
        }
        .kpi-card:hover::after {
            transform: scale(1.3);
            opacity: 0.7;
        }
        .chart-card { padding: 1.5rem; }
        .content-card { box-shadow: var(--shadow-md); }

        /* Table */
        .table-container { 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            border: 1px solid var(--border-color); 
            background-color: var(--card-bg);
            box-shadow: var(--shadow-md);
        }
        .table-header th { 
            background-color: var(--subtle-bg); 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em; 
            font-weight: 600; 
            cursor: pointer; 
            user-select: none; 
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-row { 
            border-bottom: 1px solid var(--border-color); 
            transition: background-color 0.2s ease, box-shadow 0.2s ease; 
        }
        .table-row:not(.sub-row):nth-child(even) { 
            background-color: var(--subtle-bg);
        }
        tbody tr:last-child { border-bottom: none; }
        .table-row:not(.sub-row):hover { 
            background-color: color-mix(in srgb, var(--primary-fg) 8%, transparent);
            box-shadow: inset 3px 0 0 0 var(--primary-fg);
        }
        .sub-row, .details-row { background-color: color-mix(in srgb, var(--subtle-bg) 50%, var(--card-bg)); }

        /* Forms & Inputs */
        .filter-input, .custom-select-trigger { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 0.5rem; 
            transition: all 0.2s ease; 
            color: var(--text-primary); 
            height: 42px; 
            font-weight: 500;
        }
        .filter-input:focus, .custom-select-trigger:focus, .custom-select-container.open .custom-select-trigger { 
            border-color: var(--primary-fg); 
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-fg) 30%, transparent); 
            outline: none; 
        }
        .table-checkbox {
            width: 1.15rem;
            height: 1.15rem;
            flex-shrink: 0;
            border-radius: 0.25rem;
            accent-color: var(--primary-fg);
            cursor: pointer;
        }
        
        /* Buttons */
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-fg); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--subtle-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--primary-fg); background-color: var(--primary-bg); }
        .btn-icon { padding: 0.5rem; }

        .pagination-btn:hover:not(:disabled) { background-color: var(--primary-bg); color: var(--primary-fg); }
        .pagination-btn.active { background-color: var(--primary-fg); color: white; font-weight: bold; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .quick-filter-btn { 
            padding: 0.5rem 1rem; border-radius: 9999px; border: 1px solid var(--border-color); 
            background-color: var(--card-bg); color: var(--text-secondary); 
            font-weight: 500; font-size: 0.875rem; transition: all 0.2s ease; white-space: nowrap; 
        }
        .quick-filter-btn:hover:not(:disabled) { border-color: var(--primary-fg); color: var(--primary-fg); transform: translateY(-1px); }
        .quick-filter-btn.active { 
            background-color: var(--primary-fg); color: white; border-color: var(--primary-fg); 
            font-weight: 600; box-shadow: 0 2px 4px color-mix(in srgb, var(--primary-fg) 25%, transparent); 
        }
        
        /* Status Badges */
        .status-badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .status-VENCIDO { background-color: #fee2e2; color: #b91c1c; }
        .status-A_VENCER { background-color: #fef9c3; color: #a16207; }
        .status-Pago { background-color: #dcfce7; color: #166534; }
        .status-Ignorado { background-color: #e5e7eb; color: #4b5563; }
        .status-Origem_do_parcelamento { background-color: #e0e7ff; color: #4338ca; }
        html.dark-theme .status-VENCIDO { background-color: #3f2229; color: #fca5a5; }
        html.dark-theme .status-A_VENCER { background-color: #42300f; color: #fde047; }
        html.dark-theme .status-Pago { background-color: #1a3b2a; color: #86efac; }
        html.dark-theme .status-Ignorado { background-color: #2b313d; color: #a6b0c1; }
        html.dark-theme .status-Origem_do_parcelamento { background-color: #292d4b; color: #a5b4fc; }

        /* Other component styles */
        .sort-icon { opacity: 0.4; transition: all 0.2s ease-in-out; }
        .sort-icon.active { opacity: 1; color: var(--primary-fg); }
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        html.dark-theme .loading-overlay { background-color: rgba(13, 17, 23, 0.6); }
        .loading-overlay.show { opacity: 1; pointer-events: auto; }
        .spinner { width: 48px; height: 48px; border: 5px solid var(--border-color); border-bottom-color: var(--primary-light); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-select-options { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; margin-top: 0.25rem; z-index: 50; max-height: 200px; overflow-y: auto; opacity: 0; transform: scaleY(0.95) translateY(-10px); pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; transform-origin: top; box-shadow: var(--shadow-lg); }
        .custom-select-container.open .custom-select-options { opacity: 1; transform: scaleY(1) translateY(0); pointer-events: auto; }
        .custom-select-option:hover { background-color: var(--primary-bg); }
        .kpi-value {
            white-space: nowrap;
            line-height: 1;
            font-size: clamp(1.1rem, 2vw, 1.5rem);
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Filter Drawer */
        .filter-overlay {
            background-color: color-mix(in srgb, var(--background) 50%, transparent);
            backdrop-filter: blur(2px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .filter-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .filter-drawer {
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .filter-drawer.open {
            transform: translateX(0);
        }
        .filter-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: var(--brand-danger);
            color: white;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 2px solid var(--card-bg);
        }
    </style>
</head>
<body>
    <div id="app-container" class="flex flex-col h-screen bg-[var(--background)]">
        <header class="app-header border-b border-[var(--border-color)] px-4 sm:px-6 lg:px-8 flex justify-between items-center sticky top-0 z-30 shrink-0 h-16 lg:ml-72">
            <div class="flex items-center gap-3">
                <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-md hover:bg-[var(--primary-bg)] transition-colors" aria-label="Abrir menu">
                    <i data-lucide="menu" class="w-6 h-6 text-[var(--text-secondary)]"></i>
                </button>
                <div class="font-bold tracking-[0.2em] leading-none text-[var(--text-primary)]">
                    <div class="text-xl">AVANT</div>
                    <div class="text-xl">GARDE</div>
                </div>
                <div class="h-8 w-px bg-[var(--border-color)]"></div>
                <div class="text-sm font-semibold tracking-[0.2em] text-[var(--text-secondary)]">GROUP</div>
            </div>
            <div class="flex items-center gap-4 h-full">
                <button id="theme-toggle-btn" class="p-2 rounded-md hover:bg-[var(--primary-bg)] transition-colors" aria-label="Toggle theme">
                    <i data-lucide="sun" class="w-5 h-5 text-[var(--text-secondary)]"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="h-full bg-[var(--background)] flex">
                <div id="loading-overlay" class="loading-overlay">
                    <div class="spinner"></div>
                </div>
                
                <aside id="sidebar-dashboard" class="sidebar w-72 flex-shrink-0 p-4 flex-col fixed inset-y-0 left-0 z-40 transition-transform lg:transition-all duration-300 ease-in-out -translate-x-full lg:translate-x-0 lg:flex">
                    <div class="relative flex items-center justify-center gap-4 mb-10 px-2 pt-4 h-[72px]">
                        <button id="sidebar-close-btn" class="lg:hidden absolute top-5 right-2 p-1 rounded-full hover:bg-[var(--primary-bg)]">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                        <div class="logo-full flex items-center gap-4">
                            <div class="font-bold tracking-[0.2em] leading-none text-[var(--text-primary)]">
                                <div class="text-2xl">AVANT</div>
                                <div class="text-2xl">GARDE</div>
                            </div>
                            <div class="h-10 w-px bg-[var(--border-color)]"></div>
                            <div class="text-base font-semibold tracking-[0.2em] text-[var(--text-secondary)]">GROUP</div>
                        </div>
                        <div class="logo-collapsed hidden font-bold tracking-[0.2em] leading-none text-[var(--text-primary)]">
                            <div class="text-2xl">AG</div>
                        </div>
                    </div>
                    <nav id="sidebar-company-list" class="flex flex-col gap-1 flex-1 overflow-y-auto pr-2"></nav>
                    <div class="mt-auto p-2 border-t border-[var(--border-color)]">
                        <button id="sidebar-toggle-btn" class="hidden lg:flex items-center w-full p-3 rounded-md hover:bg-[var(--primary-bg)] transition-colors">
                           <i data-lucide="chevrons-left" class="w-5 h-5 text-[var(--text-secondary)]"></i>
                           <span class="sidebar-text ml-3 font-semibold text-sm text-[var(--text-secondary)]">Recolher</span>
                       </button>
                   </div>
                </aside>
                
                <div id="main-content-wrapper" class="flex-1 flex flex-col h-full lg:ml-72">
                    <main class="flex-1 p-4 sm:p-6 lg:p-8 animate-fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-[var(--text-primary)]">Dashboard Fiscal</h1>
                            <p class="text-[var(--text-secondary)] mt-1">Análise detalhada dos débitos fiscais das empresas do <span class="font-semibold text-[var(--text-primary)]">Grupo Avant Garde</span>.</p>
                        </div>

                        <section id="kpi-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-8"></section>

                        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                            <div class="lg:col-span-2 chart-card flex flex-col">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold">Débitos por Tipo</h3>
                                    <button id="clear-tipo-filter-btn" class="text-xs text-[var(--primary-fg)] font-semibold hover:underline hidden">Limpar</button>
                                </div>
                                <div class="relative flex-1 min-h-[300px] mt-4"><canvas id="debtByTypeChart"></canvas></div>
                            </div>
                            <div class="lg:col-span-3 chart-card flex flex-col">
                                <h3 class="font-bold">Débitos por Empresa</h3>
                                <div class="relative flex-1 min-h-[300px] mt-4"><canvas id="debtByCompanyChart"></canvas></div>
                            </div>
                        </section>
                        
                        <div class="bg-[var(--card-bg)] p-4 rounded-t-xl border border-b-0 border-[var(--border-color)] flex flex-col gap-4">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="flex-1 min-w-[250px] relative">
                                    <input type="text" id="search-input" placeholder="Buscar por empresa ou débito..." class="filter-input w-full pl-10 pr-4 py-2" />
                                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-tertiary)]"><i data-lucide="search" class="w-5 h-5"></i></div>
                                </div>
                                 <div class="flex items-center gap-3">
                                    <button id="reset-view-btn" class="btn btn-secondary btn-icon" title="Resetar Visualização" aria-label="Resetar Visualização">
                                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                                    </button>
                                    <button id="refresh-data-btn" class="btn btn-secondary btn-icon" title="Atualizar Dados" aria-label="Atualizar Dados">
                                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                    </button>
                                    <div class="relative">
                                        <button id="open-filter-drawer-btn" class="btn btn-primary">
                                            <i data-lucide="filter" class="w-4 h-4"></i>
                                            <span>Filtros</span>
                                        </button>
                                        <span id="filter-badge" class="filter-badge hidden items-center justify-center rounded-full">0</span>
                                    </div>
                                 </div>
                            </div>
                             <div id="quick-filters" class="flex items-center gap-2 flex-wrap"></div>
                        </div>
                        <div class="table-container">
                             <div class="overflow-auto" style="max-height: calc(100vh - 460px);">
                                <table class="w-full text-sm">
                                    <thead id="table-head" class="table-header"></thead>
                                    <tbody id="table-body"></tbody>
                                </table>
                            </div>
                            <div id="pagination-controls" class="p-4 flex items-center justify-between flex-wrap gap-4"></div>
                        </div>

                        <footer class="py-6 mt-4 text-sm text-[var(--text-tertiary)] flex items-center justify-center gap-2">
                           <i data-lucide="shield-check" class="w-4 h-4 text-[var(--brand-success)] opacity-90"></i>
                           <span class="font-medium">Plataforma desenvolvida por <strong class="font-semibold text-[var(--text-secondary)]">Sete Soluções Fiscais</strong></span>
                        </footer>
                    </main>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>
    <!-- Filter Drawer -->
    <div id="filter-drawer-overlay" class="filter-overlay fixed inset-0 z-40"></div>
    <div id="filter-drawer" class="filter-drawer fixed top-0 right-0 h-full w-full max-w-sm bg-[var(--card-bg)] shadow-lg z-50 p-6 flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">Filtros Avançados</h3>
            <button id="close-filter-drawer-btn" class="p-1 rounded-full hover:bg-[var(--primary-bg)]"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 space-y-6 overflow-y-auto pr-3 -mr-3">
             <div class="space-y-4">
                <h4 class="text-xs font-bold uppercase text-[var(--text-secondary)] tracking-wider flex items-center gap-2"><i data-lucide="calendar-range" class="w-4 h-4"></i><span>Período de Vencimento</span></h4>
                <div>
                    <label for="startDate" class="block text-sm font-medium mb-1.5">De</label>
                    <input id="startDate" type="date" class="filter-input w-full px-3 py-2" />
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium mb-1.5">Até</label>
                    <input id="endDate" type="date" class="filter-input w-full px-3 py-2" />
                </div>
            </div>
            <hr class="border-[var(--border-color)]" />
            <div class="space-y-4">
                <h4 class="text-xs font-bold uppercase text-[var(--text-secondary)] tracking-wider flex items-center gap-2"><i data-lucide="list-filter" class="w-4 h-4"></i><span>Critérios</span></h4>
                <div id="filter-company-select"></div>
                <div id="filter-situacao-select"></div>
                <div id="filter-tipo-select"></div>
            </div>
        </div>
        <div class="mt-6 flex gap-3 border-t border-[var(--border-color)] pt-4">
            <button id="clear-filters-btn" class="btn btn-secondary w-full">Limpar Filtros</button>
            <button id="apply-filters-btn" class="btn btn-primary w-full">Aplicar</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DATA ---
    const STATUS = {
        VENCIDO: 'VENCIDO',
        A_VENCER: 'A VENCER',
        ORIGEM_PARCELAMENTO: 'Origem do parcelamento',
        PAGO: 'Pago',
        IGNORADO: 'Ignorado'
    };

    const DEBITOS_DATA_RAW = [
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "DÉBITO - ISS",
          "Competência": "03/2022",
          "Vencimento Original": "04/18/2022",
          "Principal": 2758.98,
          "Multa": 137.95,
          "Juros": 1192.15,
          "Total": 4089.08,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "DÉBITO - ISS",
          "Competência": "03/2024",
          "Vencimento Original": "04/10/2024",
          "Principal": 753.38,
          "Multa": 150.66,
          "Juros": 178.29,
          "Total": 1082.33,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "1º Trimestre 2025",
          "Vencimento Original": "05/30/2025",
          "Principal": 2631.91,
          "Multa": 526.38,
          "Juros": 181.6,
          "Total": 3339.89,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 3ª Quota",
          "Competência": "1º Trimestre 2025",
          "Vencimento Original": "06/30/2025",
          "Principal": 5080.31,
          "Multa": 1016.06,
          "Juros": 350.54,
          "Total": 6446.91,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 3ª Quota",
          "Competência": "1º Trimestre 2025",
          "Vencimento Original": "06/30/2025",
          "Principal": 2631.91,
          "Multa": 526.38,
          "Juros": 181.6,
          "Total": 3339.89,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 21866.61,
          "Multa": 4373.32,
          "Juros": 739.09,
          "Total": 26979.02,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 8628.94,
          "Multa": 1725.78,
          "Juros": 291.65,
          "Total": 10646.37,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 9112.39,
          "Multa": 1822.47,
          "Juros": 307.99,
          "Total": 11242.85,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 4000.47,
          "Multa": 800.09,
          "Juros": 135.21,
          "Total": 4935.77,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 21914.74,
          "Multa": 0,
          "Juros": 0,
          "Total": 21914.74,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 21914.73,
          "Multa": 0,
          "Juros": 0,
          "Total": 21914.73,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 21914.73,
          "Multa": 0,
          "Juros": 0,
          "Total": 21914.73,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 8921.13,
          "Multa": 0,
          "Juros": 0,
          "Total": 8921.13,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 8921.11,
          "Multa": 0,
          "Juros": 0,
          "Total": 8921.11,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 8921.11,
          "Multa": 0,
          "Juros": 0,
          "Total": 8921.11,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 31040.76,
          "Multa": 6208.15,
          "Juros": 1049.17,
          "Total": 38298.08,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 12067.17,
          "Multa": 2413.43,
          "Juros": 407.87,
          "Total": 14888.47,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 19435.69,
          "Multa": 3887.13,
          "Juros": 656.92,
          "Total": 23979.74,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "07/31/2025",
          "Principal": 8881.76,
          "Multa": 1776.35,
          "Juros": 300.2,
          "Total": 10958.31,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 9292.92,
          "Multa": 0,
          "Juros": 0,
          "Total": 9292.92,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 9292.9,
          "Multa": 0,
          "Juros": 0,
          "Total": 9292.9,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "IRPJ - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 9292.9,
          "Multa": 0,
          "Juros": 0,
          "Total": 9292.9,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 4105.83,
          "Multa": 0,
          "Juros": 0,
          "Total": 4105.83,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 4105.83,
          "Multa": 0,
          "Juros": 0,
          "Total": 4105.83,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "CSLL - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 4105.83,
          "Multa": 0,
          "Juros": 0,
          "Total": 4105.83,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 21866.61,
          "Multa": 3896.62,
          "Juros": 739.09,
          "Total": 26502.32,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 8628.93,
          "Multa": 1537.67,
          "Juros": 291.65,
          "Total": 10458.25,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 9112.37,
          "Multa": 1623.82,
          "Juros": 307.99,
          "Total": 11044.18,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant SPA (SC)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 4000.45,
          "Multa": 712.88,
          "Juros": 135.21,
          "Total": 4848.54,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 31040.76,
          "Multa": 5531.46,
          "Juros": 1049.17,
          "Total": 37621.39,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 12067.17,
          "Multa": 2150.36,
          "Juros": 407.87,
          "Total": 14625.4,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 1676.67,
          "Multa": 0,
          "Juros": 0,
          "Total": 1676.67,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 1676.66,
          "Multa": 0,
          "Juros": 0,
          "Total": 1676.66,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 1121.71,
          "Multa": 0,
          "Juros": 0,
          "Total": 1121.71,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 1121.71,
          "Multa": 0,
          "Juros": 0,
          "Total": 1121.71,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "PARCELAMENTO ISS (02/06)",
          "Competência": "10/2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 5345.95,
          "Multa": 0,
          "Juros": 0,
          "Total": 5345.95,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 19435.67,
          "Multa": 3463.43,
          "Juros": 656.92,
          "Total": 23556.02,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "08/29/2025",
          "Principal": 8881.74,
          "Multa": 1582.72,
          "Juros": 300.2,
          "Total": 10764.66,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Aguiar Duarte (SC)",
          "Nome do Débito": "COFINS",
          "Competência": "09/2025",
          "Vencimento Original": "09/25/2025",
          "Principal": 10932.8,
          "Multa": 1046.26,
          "Juros": 109.32,
          "Total": 12088.38,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "IRPJ - 3ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "09/30/2025",
          "Principal": 31040.76,
          "Multa": 2458.42,
          "Juros": 1049.17,
          "Total": 34548.35,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Avant Cursos (SP)",
          "Nome do Débito": "CSLL - 3ª Quota",
          "Competência": "2º Trimestre 2025",
          "Vencimento Original": "09/30/2025",
          "Principal": 12067.17,
          "Multa": 955.71,
          "Juros": 407.87,
          "Total": 13430.75,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRPJ - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 8869.55,
          "Multa": 0,
          "Juros": 0,
          "Total": 8869.55,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRPJ - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 8869.53,
          "Multa": 0,
          "Juros": 0,
          "Total": 8869.53,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRPJ - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 8869.53,
          "Multa": 0,
          "Juros": 0,
          "Total": 8869.53,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "CSLL - 1ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 4716.31,
          "Multa": 0,
          "Juros": 0,
          "Total": 4716.31,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "CSLL - 2ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "11/28/2025",
          "Principal": 4716.29,
          "Multa": 0,
          "Juros": 0,
          "Total": 4716.29,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "CSLL - 3ª Quota",
          "Competência": "3º Trimestre 2025",
          "Vencimento Original": "12/30/2025",
          "Principal": 4716.29,
          "Multa": 0,
          "Juros": 0,
          "Total": 4716.29,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "PARCELAMENTO 2 (15/34)",
          "Competência": "10/2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 588.68,
          "Multa": 0,
          "Juros": 0,
          "Total": 588.68,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "PARCELAMENTO 1 (3/6)",
          "Competência": "10/2025",
          "Vencimento Original": "10/31/2025",
          "Principal": 9810.21,
          "Multa": 0,
          "Juros": 0,
          "Total": 9810.21,
          "Situação": "A VENCER"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "PARCELAMENTO 1 (2/6)",
          "Competência": "09/2025",
          "Vencimento Original": "09/30/2025",
          "Principal": 9810.21,
          "Multa": 0,
          "Juros": 0,
          "Total": 9810.21,
          "Situação": "VENCIDO"
         },
         {
          "Empresa": "Instituto de Fisiologia (SP)",
          "Nome do Débito": "IRRF ALUG E ROYALTIES PAGOS A PF",
          "Competência": "09/2025",
          "Vencimento Original": "10/20/2025",
          "Principal": 4591.27,
          "Multa": 0,
          "Juros": 0,
          "Total": 4591.27,
          "Situação": "VENCIDO"
         }
    ];

    // --- UTILS ---
    const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    const parseDate = (d) => {
        if (typeof d !== 'string' || !d.trim()) return null;
        const cleanedDateStr = d.trim();
        const parts = cleanedDateStr.split('/');
        if (parts.length !== 3) return null;
        const [month, day, yearStr] = parts; // Handles MM/DD/YYYY
        let year = parseInt(yearStr, 10);
        if (year < 100) { year += 2000; }
        const date = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
        if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getDate() !== parseInt(day, 10)) return null;
        return date;
    };
    const formatDate = (date) => {
        if (!date) return 'N/A';
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
    const parseNumericValue = (val) => {
        if (typeof val === 'number') return val;
        if (typeof val === 'string') {
            const cleaned = val.replace(/R\$\s?/, '').trim();
            if (cleaned === '' || cleaned === '-') return 0;
            return parseFloat(cleaned.replace(/\./g, '').replace(',', '.')) || 0;
        }
        return 0;
    };
    const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    const extractType = (name) => {
        if (typeof name !== 'string') return 'Outro';
        const lowerName = name.toLowerCase();
        if (lowerName.includes('irpj')) return 'IRPJ';
        if (lowerName.includes('csll')) return 'CSLL';
        if (lowerName.includes('pis')) return 'PIS';
        if (lowerName.includes('cofins')) return 'COFINS';
        if (lowerName.includes('iss')) return 'ISS';
        if (lowerName.includes('parcelamento')) return 'Parcelamento';
        if (lowerName.includes('fgts')) return 'FGTS';
        if (lowerName.includes('iof')) return 'IOF';
        if (lowerName.includes('contribuições')) return 'Folha';
        return 'Outro';
    };
    const parseInstallmentDetails = (row) => {
        const competenceRegex = /(\d+)\/(\d+)/;
        const totalValueRegex = /valor total R\$ ([\d.,]+)/i;
        const balanceRegex = /saldo devedor ([\d.,]+)/i;
        const competenceMatch = row['Competência']?.toString().match(competenceRegex);
        const totalValueMatch = row['Nome do Débito']?.match(totalValueRegex);
        const balanceMatch = row['Nome do Débito']?.match(balanceRegex) || row.Column10?.match(balanceRegex);
        return {
            paidCount: competenceMatch ? parseInt(competenceMatch[1]) : null,
            totalCount: competenceMatch ? parseInt(competenceMatch[2]) : null,
            totalValue: totalValueMatch ? parseNumericValue(totalValueMatch[1]) : null,
            remainingBalance: balanceMatch ? parseNumericValue(balanceMatch[1]) : null,
        };
    };

    const animateValue = (el, start, end, duration, formatFn) => {
        if (start === end) {
            el.textContent = formatFn(end);
            return;
        }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const current = progress * (end - start) + start;
            el.textContent = formatFn(current);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    };

    const getNestedValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

    // --- STATE & DATA PROCESSING ---
    let state = {
        isLoading: true,
        processedData: [],
        activeCompanies: new Set(),
        sort: { key: 'vencimento', dir: 'asc' },
        pagination: { currentPage: 1, itemsPerPage: 10 },
        filters: { search: '', startDate: '', endDate: '', situacoes: [], tipos: [], chartTipo: null },
        tempFilters: { search: '', startDate: '', endDate: '', situacoes: [], tipos: [], chartTipo: null },
        tempActiveCompanies: new Set(),
        expandedRows: new Set(),
        kpis: null,
    };

    let allCompanies = [], allSituacoes = [], allTipos = [];
    let debtByTypeChart, debtByCompanyChart;
    
    const processData = (rawData) => {
        const sanitizedData = rawData.map(row => ({...row, Total: row[' Total '] ? row[' Total '] : row.Total, Empresa: row.Empresa ? row.Empresa : row.EMPRESA}));
        let idCounter = 0;

        return sanitizedData.reduce((acc, row) => {
            if (!row.Empresa || !row['Nome do Débito']) return acc;

            const commonData = {
                id: `debt-${idCounter++}`,
                empresa: row.Empresa.trim(),
                nomeDebito: row['Nome do Débito'],
                competencia: String(row.Competência),
                vencimento: row['Vencimento Original'],
                valor: parseNumericValue(row.Total),
                multa: parseNumericValue(row.Multa),
                juros: parseNumericValue(row.Juros),
                situacao: row.Situação,
                tipo: extractType(row['Nome do Débito'])
            };

            if (commonData.tipo === 'Parcelamento') {
                commonData.installmentDetails = parseInstallmentDetails(row);
            }

            if (row.Situação === STATUS.ORIGEM_PARCELAMENTO) {
                const lastParcelamento = [...acc].reverse().find(d => d.tipo === 'Parcelamento' && d.empresa === commonData.empresa);
                if (lastParcelamento) {
                    if (!lastParcelamento.subRows) lastParcelamento.subRows = [];
                    lastParcelamento.subRows.push(commonData);
                } else {
                    acc.push(commonData);
                }
            } else {
                acc.push(commonData);
            }
            return acc;
        }, []);
    };
    
    // --- DOM Elements ---
    const dom = {
        dashboardView: document.getElementById('dashboard-view'),
        loadingOverlay: document.getElementById('loading-overlay'),
        kpiCardsContainer: document.getElementById('kpi-cards'),
        tableHead: document.getElementById('table-head'),
        tableBody: document.getElementById('table-body'),
        paginationControls: document.getElementById('pagination-controls'),
        searchInput: document.getElementById('search-input'),
        quickFiltersContainer: document.getElementById('quick-filters'),
        sidebarCompanyList: document.getElementById('sidebar-company-list'),
        filterBadge: document.getElementById('filter-badge'),
        filterDrawer: document.getElementById('filter-drawer'),
        filterDrawerOverlay: document.getElementById('filter-drawer-overlay'),
        filterCompanySelect: document.getElementById('filter-company-select'),
        filterSituacaoSelect: document.getElementById('filter-situacao-select'),
        filterTipoSelect: document.getElementById('filter-tipo-select'),
        themeToggleButton: document.getElementById('theme-toggle-btn'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        sidebar: document.getElementById('sidebar-dashboard'),
        sidebarCloseBtn: document.getElementById('sidebar-close-btn'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        sidebarToggleBtn: document.getElementById('sidebar-toggle-btn'),
        mainContentWrapper: document.getElementById('main-content-wrapper'),
        appHeader: document.querySelector('.app-header'),
    };

    // --- Loading State UI ---
    const getKpiSkeletons = () => {
        let html = '';
        for (let i = 0; i < 6; i++) {
            html += `
                <div class="kpi-card !p-5" style="--kpi-border-color: transparent;">
                    <div class="skeleton-loader h-4 w-2/3 mb-6"></div>
                    <div class="skeleton-loader h-8 w-1/2"></div>
                </div>`;
        }
        return html;
    };

    const getTableSkeletons = () => {
        let html = '';
        const itemsToRender = state.pagination.itemsPerPage;
        for (let i = 0; i < itemsToRender; i++) {
            html += `
                <tr class="table-row">
                    <td class="p-3 w-8"></td>
                    <td class="p-4"><div class="skeleton-loader h-5"></div></td>
                    <td class="p-4"><div class="skeleton-loader h-5"></div></td>
                    <td class="p-4"><div class="skeleton-loader h-5"></div></td>
                    <td class="p-4"><div class="skeleton-loader h-5"></div></td>
                    <td class="p-4"><div class="skeleton-loader h-5"></div></td>
                </tr>`;
        }
        return html;
    };

    const setDashboardLoading = (isLoading) => {
        const mainContent = document.querySelector('#dashboard-view main');
        if (!mainContent) return;

        if (isLoading) {
            dom.kpiCardsContainer.innerHTML = getKpiSkeletons();
            dom.tableBody.innerHTML = getTableSkeletons();
            dom.tableHead.innerHTML = ''; // Clear headers with sort icons
            dom.paginationControls.innerHTML = '';
            document.querySelectorAll('.chart-card canvas').forEach(c => c.style.filter = 'blur(4px)');
            mainContent.classList.add('dashboard-loading');
        } else {
            document.querySelectorAll('.chart-card canvas').forEach(c => c.style.filter = 'none');
            mainContent.classList.remove('dashboard-loading');
        }
    };
    
    // --- RENDER FUNCTIONS ---
    const renderKPIs = (currentKpis, prevKpis) => {
        const kpiData = [
            { id: "kpi-total-debt", title: "Débitos Totais", rawValue: currentKpis.totalDebt, icon: "landmark", color: getCssVar('--primary-fg') },
            { id: "kpi-overdue-debt", title: "Débitos Vencidos", rawValue: currentKpis.overdueDebt, icon: "siren", color: getCssVar('--danger') },
            { id: "kpi-upcoming-debt", title: "A Vencer", rawValue: currentKpis.upcomingDebt, icon: "calendar-check", color: getCssVar('--warning') },
            { id: "kpi-total-juros", title: "Total em Juros", rawValue: currentKpis.totalJuros, icon: "trending-up", color: getCssVar('--brand-purple') },
            { id: "kpi-total-multa", title: "Total em Multa", rawValue: currentKpis.totalMulta, icon: "receipt", color: getCssVar('--brand-pink') },
            { id: "kpi-debts-count", title: "Débitos Filtrados", rawValue: currentKpis.totalDebtsCount, icon: "file-stack", color: getCssVar('--success') }
        ];
    
        const startKpis = prevKpis || currentKpis;

        dom.kpiCardsContainer.innerHTML = kpiData.map(kpi => {
            const isCount = kpi.id === 'kpi-debts-count';
            let initialValue;
            switch(kpi.id) {
                case 'kpi-total-debt': initialValue = startKpis.totalDebt; break;
                case 'kpi-overdue-debt': initialValue = startKpis.overdueDebt; break;
                case 'kpi-upcoming-debt': initialValue = startKpis.upcomingDebt; break;
                case 'kpi-total-juros': initialValue = startKpis.totalJuros; break;
                case 'kpi-total-multa': initialValue = startKpis.totalMulta; break;
                case 'kpi-debts-count': initialValue = startKpis.totalDebtsCount; break;
            }
            const formattedValue = isCount ? Math.round(initialValue).toString() : formatCurrency(initialValue);
            
            return `
            <div class="kpi-card" style="--kpi-border-color: ${kpi.color};">
                <div class="flex items-start justify-between">
                    <h3 class="font-semibold text-[var(--text-secondary)] uppercase text-xs tracking-wider">${kpi.title}</h3>
                    <div class="p-2 rounded-md" style="background-color: ${kpi.color}1A;">
                        <i data-lucide="${kpi.icon}" class="w-5 h-5" style="color: ${kpi.color};"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <p id="${kpi.id}" class="kpi-value font-bold text-[var(--text-primary)]">${formattedValue}</p>
                </div>
            </div>
            `;
        }).join('');
        lucide.createIcons();

        if (prevKpis) {
            kpiData.forEach(kpi => {
                const el = document.getElementById(kpi.id);
                if (el) {
                    const isCount = kpi.id === 'kpi-debts-count';
                    const formatFn = isCount ? val => Math.round(val).toString() : formatCurrency;
                    let startVal;
                     switch(kpi.id) {
                        case 'kpi-total-debt': startVal = startKpis.totalDebt; break;
                        case 'kpi-overdue-debt': startVal = startKpis.overdueDebt; break;
                        case 'kpi-upcoming-debt': startVal = startKpis.upcomingDebt; break;
                        case 'kpi-total-juros': startVal = startKpis.totalJuros; break;
                        case 'kpi-total-multa': startVal = startKpis.totalMulta; break;
                        case 'kpi-debts-count': startVal = startKpis.totalDebtsCount; break;
                    }
                    animateValue(el, startVal, kpi.rawValue, 800, formatFn);
                }
            });
        }
    };

    const renderCharts = (data) => {
        const debtByType = data.reduce((acc, item) => {
            if (item.situacao !== STATUS.PAGO && item.situacao !== STATUS.IGNORADO) {
                acc[item.tipo] = (acc[item.tipo] || 0) + item.valor;
            }
            return acc;
        }, {});
        
        const debtByCompany = data.reduce((acc, item) => {
            if (item.situacao !== STATUS.PAGO && item.situacao !== STATUS.IGNORADO) {
                acc[item.empresa] = (acc[item.empresa] || 0) + item.valor;
            }
            return acc;
        }, {});

        const sortedDebtByCompany = Object.entries(debtByCompany).sort(([, a], [, b]) => b - a);
        const top5Companies = sortedDebtByCompany.slice(0, 5);
        const otherCompaniesTotal = sortedDebtByCompany.slice(5).reduce((sum, [, value]) => sum + value, 0);
        if (otherCompaniesTotal > 0) {
            top5Companies.push(['Outras', otherCompaniesTotal]);
        }

        const chartColors = [
            getCssVar('--primary-fg'), getCssVar('--brand-gold'), getCssVar('--brand-purple'),
            getCssVar('--brand-success'), getCssVar('--brand-pink'), getCssVar('--brand-warning'),
            '#4ade80', '#fb923c', '#38bdf8'
        ];

        // Debt By Type Chart (Pie)
        if (debtByTypeChart) debtByTypeChart.destroy();
        debtByTypeChart = new Chart(document.getElementById('debtByTypeChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(debtByType),
                datasets: [{
                    label: 'Débitos por Tipo',
                    data: Object.values(debtByType),
                    backgroundColor: chartColors,
                    borderColor: getCssVar('--card-bg'),
                    borderWidth: 3,
                    hoverOffset: 10,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: getCssVar('--text-secondary'), usePointStyle: true, boxWidth: 8 } },
                    tooltip: {
                        callbacks: { label: (context) => ` ${context.label}: ${formatCurrency(context.raw)}` }
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const clickedLabel = debtByTypeChart.data.labels[elements[0].index];
                        state.filters.chartTipo = clickedLabel;
                        document.getElementById('clear-tipo-filter-btn').classList.remove('hidden');
                        applyFiltersAndRender();
                    }
                }
            }
        });

        // Debt By Company Chart (Bar)
        const barCtx = document.getElementById('debtByCompanyChart').getContext('2d');
        const barGradient = barCtx.createLinearGradient(0, 0, 0, barCtx.canvas.height);
        barGradient.addColorStop(0, getCssVar('--primary-fg'));
        barGradient.addColorStop(1, getCssVar('--primary-bg'));
        if (debtByCompanyChart) debtByCompanyChart.destroy();
        debtByCompanyChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: top5Companies.map(([name]) => name.length > 20 ? name.substring(0, 18) + '...' : name),
                datasets: [{
                    label: 'Débitos por Empresa',
                    data: top5Companies.map(([, value]) => value),
                    backgroundColor: barGradient,
                    borderColor: getCssVar('--primary-fg'),
                    borderWidth: 2,
                    borderRadius: 6,
                    hoverBackgroundColor: getCssVar('--primary-fg'),
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: getCssVar('--border-color') },
                        ticks: { color: getCssVar('--text-tertiary'), callback: (value) => formatCurrency(value).replace('R$', '') }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: getCssVar('--text-secondary') }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => ` ${context.dataset.label}: ${formatCurrency(context.raw)}`
                        }
                    }
                }
            }
        });
    };

    const renderTable = (data, sort, pagination) => {
        renderTableHeader(sort);
        renderTableBody(data, pagination);
        renderPagination(data.length, pagination);
        lucide.createIcons();
    };

    const renderTableHeader = (sort) => {
        const headers = [
            { key: 'empresa', label: 'Empresa', class: 'w-1/4' },
            { key: 'nomeDebito', label: 'Nome do Débito', class: 'w-1/4' },
            { key: 'vencimento', label: 'Vencimento', class: 'w-1/6' },
            { key: 'valor', label: 'Valor Atual', class: 'w-1/6 text-right' },
            { key: 'situacao', label: 'Situação', class: 'w-1/6' },
        ];
        dom.tableHead.innerHTML = `
            <tr>
                <th class="p-3 w-8"></th>
                ${headers.map(h => `
                    <th class="p-4 text-left ${h.class}" data-sort-key="${h.key}">
                        <div class="flex items-center ${h.key === 'valor' ? 'justify-end': ''}">
                            <span>${h.label}</span>
                            <i data-lucide="chevrons-up-down" class="ml-2 w-4 h-4 sort-icon ${sort.key === h.key ? 'active' : ''}"></i>
                        </div>
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const renderTableBody = (data, pagination) => {
        const { currentPage, itemsPerPage } = pagination;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = data.slice(startIndex, endIndex);

        if (pageData.length === 0) {
            dom.tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-12">
                        <i data-lucide="search-x" class="w-12 h-12 text-[var(--text-tertiary)] mx-auto mb-4"></i>
                        <h3 class="font-semibold">Nenhum resultado encontrado</h3>
                        <p class="text-[var(--text-secondary)] mt-1">Tente ajustar seus filtros de busca.</p>
                    </td>
                </tr>`;
            return;
        }

        let tableHtml = '';
        pageData.forEach((item, index) => {
            const isExpanded = state.expandedRows.has(item.id);
            tableHtml += `
                <tr class="table-row" data-id="${item.id}" style="--animation-delay: ${index * 50}ms">
                    <td class="p-3 w-8 text-center">
                        ${item.subRows && item.subRows.length > 0 ? `<button class="expand-btn p-1 rounded-full hover:bg-[var(--primary-bg)]"><i data-lucide="${isExpanded ? 'chevron-down' : 'chevron-right'}" class="w-4 h-4"></i></button>` : ''}
                    </td>
                    <td class="p-4 font-semibold">${item.empresa}</td>
                    <td class="p-4 text-[var(--text-secondary)]">${item.nomeDebito}</td>
                    <td class="p-4">${formatDate(parseDate(item.vencimento))}</td>
                    <td class="p-4 font-semibold text-right">${formatCurrency(item.valor)}</td>
                    <td class="p-4"><span class="status-badge status-${item.situacao.replace(/\s+/g, '_')}">${item.situacao}</span></td>
                </tr>
            `;

            if (isExpanded && item.subRows) {
                item.subRows.forEach(subItem => {
                    tableHtml += `
                    <tr class="table-row sub-row" data-parent-id="${item.id}">
                        <td></td>
                        <td class="p-4 pl-8 text-[var(--text-secondary)]" colspan="2">${subItem.nomeDebito}</td>
                        <td class="p-4">${formatDate(parseDate(subItem.vencimento))}</td>
                        <td class="p-4 font-semibold text-right">${formatCurrency(subItem.valor)}</td>
                        <td class="p-4"><span class="status-badge status-Origem_do_parcelamento">Origem do Parcelamento</span></td>
                    </tr>
                    `;
                });
            }
        });
        dom.tableBody.innerHTML = tableHtml;
        requestAnimationFrame(() => {
            document.querySelectorAll('.table-row').forEach(row => row.classList.add('animate-in'));
        });
    };

    const renderPagination = (totalItems, pagination) => {
        const { currentPage, itemsPerPage } = pagination;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (totalPages <= 1) {
            dom.paginationControls.innerHTML = '';
            return;
        }

        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        if (endPage - startPage + 1 < maxButtons) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        let buttonsHtml = '';
        for (let i = startPage; i <= endPage; i++) {
            buttonsHtml += `<button class="pagination-btn px-4 py-2 rounded-md ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }

        dom.paginationControls.innerHTML = `
            <span class="text-sm text-[var(--text-secondary)]">Mostrando ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)} a ${Math.min(currentPage * itemsPerPage, totalItems)} de ${totalItems}</span>
            <div class="flex items-center gap-2">
                <button class="pagination-btn p-2 rounded-md" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                ${startPage > 1 ? '<span class="px-2">...</span>' : ''}
                ${buttonsHtml}
                ${endPage < totalPages ? '<span class="px-2">...</span>' : ''}
                <button class="pagination-btn p-2 rounded-md" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
        `;
    };

    const renderSidebar = (companies, activeCompanies) => {
        const companyItems = companies.map(company => `
            <div class="flex items-center">
                <label class="sidebar-label flex-1 flex items-center gap-3 p-2 rounded-md cursor-pointer transition-colors">
                    <input type="checkbox" class="table-checkbox company-checkbox" value="${company}" ${activeCompanies.has(company) ? 'checked' : ''}>
                    <span class="sidebar-text font-medium text-sm">${company}</span>
                </label>
            </div>
        `).join('');

        dom.sidebarCompanyList.innerHTML = `
            <h3 class="text-xs font-bold uppercase text-[var(--text-secondary)] tracking-wider px-2 mb-2 sidebar-text">Empresas</h3>
            <div class="flex items-center px-2 pb-2 border-b border-[var(--border-color)] sidebar-text">
                <button id="select-all-companies" class="text-xs font-semibold text-[var(--primary-fg)] hover:underline">Selecionar Todas</button>
                <span class="mx-2 text-[var(--text-tertiary)]">|</span>
                <button id="clear-all-companies" class="text-xs font-semibold text-[var(--primary-fg)] hover:underline">Limpar</button>
            </div>
            <div class="mt-4 space-y-1">${companyItems}</div>
        `;
    };

    const createCustomSelect = (container, options, placeholder, selectedValues, onSelectionChange) => {
        const selectId = `custom-select-${container.id}`;
        container.innerHTML = `
            <div class="custom-select-container relative" id="${selectId}-container">
                <button class="custom-select-trigger flex items-center justify-between w-full px-3 py-2 text-left" aria-haspopup="listbox" aria-expanded="false">
                    <span class="truncate">${placeholder}</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-[var(--text-tertiary)] transition-transform"></i>
                </button>
                <div class="custom-select-options p-2" role="listbox">
                    ${options.map(opt => `
                        <div class="custom-select-option flex items-center gap-3 p-2 rounded-md cursor-pointer" role="option" data-value="${opt}">
                            <input type="checkbox" class="table-checkbox pointer-events-none" ${selectedValues.includes(opt) ? 'checked' : ''}>
                            <span class="text-sm">${opt}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        lucide.createIcons();

        const customSelect = document.getElementById(`${selectId}-container`);
        const trigger = customSelect.querySelector('.custom-select-trigger');
        const triggerText = trigger.querySelector('span');
        const optionsContainer = customSelect.querySelector('.custom-select-options');
        const optionItems = optionsContainer.querySelectorAll('.custom-select-option');

        const updateTriggerText = () => {
            const selectedCount = selectedValues.length;
            if (selectedCount === 0) {
                triggerText.textContent = placeholder;
            } else if (selectedCount === 1) {
                triggerText.textContent = selectedValues[0];
            } else {
                triggerText.textContent = `${selectedCount} selecionado(s)`;
            }
        };

        trigger.addEventListener('click', () => {
            const isOpen = customSelect.classList.toggle('open');
            trigger.setAttribute('aria-expanded', isOpen);
        });

        optionItems.forEach(option => {
            option.addEventListener('click', (e) => {
                e.stopPropagation();
                const value = option.getAttribute('data-value');
                const checkbox = option.querySelector('input');
                if (selectedValues.includes(value)) {
                    selectedValues.splice(selectedValues.indexOf(value), 1);
                    checkbox.checked = false;
                } else {
                    selectedValues.push(value);
                    checkbox.checked = true;
                }
                updateTriggerText();
                onSelectionChange(selectedValues);
            });
        });

        document.addEventListener('click', (e) => {
            if (!customSelect.contains(e.target)) {
                customSelect.classList.remove('open');
                trigger.setAttribute('aria-expanded', 'false');
            }
        });

        updateTriggerText();
    };

    const renderFilterDrawer = () => {
        createCustomSelect(
            dom.filterCompanySelect, allCompanies, 'Filtrar por Empresa', 
            Array.from(state.tempActiveCompanies), 
            (selection) => { state.tempActiveCompanies = new Set(selection); }
        );
        createCustomSelect(
            dom.filterSituacaoSelect, allSituacoes, 'Filtrar por Situação',
            state.tempFilters.situacoes,
            (selection) => { state.tempFilters.situacoes = selection; }
        );
        createCustomSelect(
            dom.filterTipoSelect, allTipos, 'Filtrar por Tipo de Débito',
            state.tempFilters.tipos,
            (selection) => { state.tempFilters.tipos = selection; }
        );
    };

    const updateFilterBadge = () => {
        let count = 0;
        if (state.filters.search) count++;
        if (state.filters.startDate || state.filters.endDate) count++;
        if (allCompanies.length > 0 && state.activeCompanies.size > 0 && state.activeCompanies.size < allCompanies.length) {
            count += state.activeCompanies.size;
        }
        count += state.filters.situacoes.length;
        count += state.filters.tipos.length;

        if (count > 0) {
            dom.filterBadge.textContent = count;
            dom.filterBadge.classList.remove('hidden');
            dom.filterBadge.classList.add('flex');
        } else {
            dom.filterBadge.classList.add('hidden');
            dom.filterBadge.classList.remove('flex');
        }
    };


    // --- EVENT HANDLERS ---
    const setupEventListeners = () => {
        dom.tableHead.addEventListener('click', (e) => {
            const header = e.target.closest('th[data-sort-key]');
            if (header) {
                const key = header.dataset.sortKey;
                const dir = state.sort.key === key && state.sort.dir === 'asc' ? 'desc' : 'asc';
                state.sort = { key, dir };
                applyFiltersAndRender();
            }
        });

        dom.paginationControls.addEventListener('click', (e) => {
            const button = e.target.closest('.pagination-btn');
            if (button && !button.disabled) {
                state.pagination.currentPage = parseInt(button.dataset.page);
                applyFiltersAndRender();
            }
        });
        
        dom.searchInput.addEventListener('input', (e) => {
            state.filters.search = e.target.value.toLowerCase();
            state.pagination.currentPage = 1;
            applyFiltersAndRender();
        });

        dom.sidebarCompanyList.addEventListener('change', (e) => {
            if (e.target.classList.contains('company-checkbox')) {
                const company = e.target.value;
                e.target.checked ? state.activeCompanies.add(company) : state.activeCompanies.delete(company);
                applyFiltersAndRender();
            }
        });

        dom.sidebarCompanyList.addEventListener('click', (e) => {
            if (e.target.id === 'select-all-companies') {
                state.activeCompanies = new Set(allCompanies);
                applyFiltersAndRender();
            }
            if (e.target.id === 'clear-all-companies') {
                state.activeCompanies.clear();
                applyFiltersAndRender();
            }
        });

        document.getElementById('clear-tipo-filter-btn').addEventListener('click', () => {
            state.filters.chartTipo = null;
            document.getElementById('clear-tipo-filter-btn').classList.add('hidden');
            applyFiltersAndRender();
        });
        
        document.getElementById('open-filter-drawer-btn').addEventListener('click', () => toggleFilterDrawer(true));
        document.getElementById('close-filter-drawer-btn').addEventListener('click', () => toggleFilterDrawer(false));
        dom.filterDrawerOverlay.addEventListener('click', () => toggleFilterDrawer(false));

        document.getElementById('apply-filters-btn').addEventListener('click', () => {
            state.filters = { ...state.filters, ...state.tempFilters };
            state.activeCompanies = new Set(state.tempActiveCompanies);
            applyFiltersAndRender();
            toggleFilterDrawer(false);
        });

        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            state.tempFilters = { search: state.filters.search, startDate: '', endDate: '', situacoes: [], tipos: [], chartTipo: state.filters.chartTipo };
            state.tempActiveCompanies = new Set(allCompanies);
            renderFilterDrawer();
        });

        document.getElementById('startDate').addEventListener('change', (e) => {
            state.tempFilters.startDate = e.target.value;
        });

        document.getElementById('endDate').addEventListener('change', (e) => {
            state.tempFilters.endDate = e.target.value;
        });

        dom.tableBody.addEventListener('click', (e) => {
            // Expand/Collapse Sub-rows
            if (e.target.closest('.expand-btn')) {
                const row = e.target.closest('tr');
                const id = row.dataset.id;
                state.expandedRows.has(id) ? state.expandedRows.delete(id) : state.expandedRows.add(id);
                applyFiltersAndRender();
            }
        });

        document.getElementById('refresh-data-btn').addEventListener('click', () => {
            init();
        });

        document.getElementById('reset-view-btn').addEventListener('click', () => {
            state.filters = { search: '', startDate: '', endDate: '', situacoes: [], tipos: [], chartTipo: null };
            state.activeCompanies = new Set(allCompanies);
            state.sort = { key: 'vencimento', dir: 'asc' };
            state.pagination.currentPage = 1;
            dom.searchInput.value = '';
            document.getElementById('clear-tipo-filter-btn').classList.add('hidden');
            applyFiltersAndRender();
        });
        
        // Theme Toggle
        dom.themeToggleButton.addEventListener('click', toggleTheme);

        // Sidebar Toggles
        dom.mobileMenuBtn.addEventListener('click', () => toggleMobileSidebar(true));
        dom.sidebarCloseBtn.addEventListener('click', () => toggleMobileSidebar(false));
        dom.sidebarOverlay.addEventListener('click', () => toggleMobileSidebar(false));

        dom.sidebarToggleBtn.addEventListener('click', () => {
            const isCollapsed = dom.sidebar.classList.contains('collapsed');
            toggleDesktopSidebar(!isCollapsed);
        });
    };
    
    // --- LOGIC FUNCTIONS ---
    const toggleFilterDrawer = (open) => {
        if (open) {
            state.tempFilters = { ...state.filters };
            state.tempActiveCompanies = new Set(state.activeCompanies);
            document.getElementById('startDate').value = state.tempFilters.startDate;
            document.getElementById('endDate').value = state.tempFilters.endDate;
            renderFilterDrawer();
            dom.filterDrawer.classList.add('open');
            dom.filterDrawerOverlay.classList.add('open');
        } else {
            dom.filterDrawer.classList.remove('open');
            dom.filterDrawerOverlay.classList.remove('open');
        }
    };
    
    const toggleMobileSidebar = (show) => {
        if (show) {
            dom.sidebar.classList.remove('-translate-x-full');
            dom.sidebar.classList.add('translate-x-0');
            dom.sidebarOverlay.classList.remove('hidden');
        } else {
            dom.sidebar.classList.add('-translate-x-full');
            dom.sidebar.classList.remove('translate-x-0');
            dom.sidebarOverlay.classList.add('hidden');
        }
    };

    const toggleDesktopSidebar = (collapse) => {
        const icon = dom.sidebarToggleBtn.querySelector('i');
        const text = dom.sidebarToggleBtn.querySelector('.sidebar-text');
        if (collapse) {
            dom.sidebar.classList.add('collapsed');
            dom.mainContentWrapper.classList.remove('lg:ml-72');
            dom.mainContentWrapper.classList.add('lg:ml-20');
            dom.appHeader.classList.remove('lg:ml-72');
            dom.appHeader.classList.add('lg:ml-20');

            if (icon) icon.setAttribute('data-lucide', 'chevrons-right');
            if (text) text.textContent = 'Expandir';
            localStorage.setItem('sidebarCollapsed', 'true');
        } else {
            dom.sidebar.classList.remove('collapsed');
            dom.mainContentWrapper.classList.remove('lg:ml-20');
            dom.mainContentWrapper.classList.add('lg:ml-72');
            dom.appHeader.classList.remove('lg:ml-20');
            dom.appHeader.classList.add('lg:ml-72');

            if (icon) icon.setAttribute('data-lucide', 'chevrons-left');
            if (text) text.textContent = 'Recolher';
            localStorage.setItem('sidebarCollapsed', 'false');
        }
        lucide.createIcons();
        // Resizing charts after transition
        setTimeout(() => {
            if (debtByTypeChart) debtByTypeChart.resize();
            if (debtByCompanyChart) debtByCompanyChart.resize();
        }, 300);
    };

    const applyFiltersAndRender = () => {
        const { search, startDate, endDate, situacoes, tipos, chartTipo } = state.filters;
        let filteredData = state.processedData;

        // Company filter
        if (state.activeCompanies.size > 0 && state.activeCompanies.size < allCompanies.length) {
            filteredData = filteredData.filter(d => state.activeCompanies.has(d.empresa));
        }

        // Search filter
        if (search) {
            filteredData = filteredData.filter(d => 
                d.empresa.toLowerCase().includes(search) || 
                d.nomeDebito.toLowerCase().includes(search)
            );
        }

        // Date filter
        const start = startDate ? new Date(startDate + 'T00:00:00') : null;
        const end = endDate ? new Date(endDate + 'T23:59:59') : null;
        if (start || end) {
            filteredData = filteredData.filter(d => {
                const vencimentoDate = parseDate(d.vencimento);
                if (!vencimentoDate) return false;
                if (start && vencimentoDate < start) return false;
                if (end && vencimentoDate > end) return false;
                return true;
            });
        }
        
        // Dropdown filters
        if (situacoes.length > 0) {
            filteredData = filteredData.filter(d => situacoes.includes(d.situacao));
        }
        if (tipos.length > 0) {
            filteredData = filteredData.filter(d => tipos.includes(d.tipo));
        }

        // Chart filter
        if (chartTipo) {
            filteredData = filteredData.filter(d => d.tipo === chartTipo);
        }

        // Sorting
        const { key, dir } = state.sort;
        filteredData.sort((a, b) => {
            let valA, valB;
            if (key === 'vencimento') {
                valA = parseDate(a[key]) || 0;
                valB = parseDate(b[key]) || 0;
            } else {
                valA = getNestedValue(a, key);
                valB = getNestedValue(b, key);
            }
            if (valA < valB) return dir === 'asc' ? -1 : 1;
            if (valA > valB) return dir === 'asc' ? 1 : -1;
            return 0;
        });

        const prevKpis = state.kpis;
        updateKpis(filteredData);
        
        renderKPIs(state.kpis, prevKpis);
        renderCharts(filteredData);
        renderTable(filteredData, state.sort, state.pagination);
        renderSidebar(allCompanies, state.activeCompanies);
        updateFilterBadge();
    };

    const updateKpis = (data) => {
        state.kpis = data.reduce((acc, item) => {
            const itemValue = item.valor;
            if (item.situacao !== STATUS.PAGO && item.situacao !== STATUS.IGNORADO) {
                acc.totalDebt += itemValue;
                acc.totalDebtsCount += 1;
                acc.totalJuros += item.juros;
                acc.totalMulta += item.multa;
                if (item.situacao === STATUS.VENCIDO) acc.overdueDebt += itemValue;
                if (item.situacao === STATUS.A_VENCER) acc.upcomingDebt += itemValue;
            }
            return acc;
        }, { totalDebt: 0, overdueDebt: 0, upcomingDebt: 0, totalJuros: 0, totalMulta: 0, totalDebtsCount: 0 });
    };

    const toggleTheme = () => {
        const isDark = document.documentElement.classList.toggle('dark-theme');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        const iconContainer = dom.themeToggleButton;
        if (iconContainer) {
            // Clear current icon (which is an svg after the first render) and add a new <i> element
            iconContainer.innerHTML = `<i data-lucide="${isDark ? 'moon' : 'sun'}" class="w-5 h-5 text-[var(--text-secondary)]"></i>`;
            lucide.createIcons();
        }
        applyFiltersAndRender(); // Re-render charts with new theme colors
    };
    
    const init = () => {
        setDashboardLoading(true);
        dom.loadingOverlay.classList.add('show');
        
        setTimeout(() => {
            // Process main dashboard data
            state.processedData = processData(DEBITOS_DATA_RAW);
            allCompanies = [...new Set(state.processedData.map(d => d.empresa))].sort();
            allSituacoes = [...new Set(state.processedData.map(d => d.situacao))].sort();
            allTipos = [...new Set(state.processedData.map(d => d.tipo))].sort();
            state.activeCompanies = new Set(allCompanies);

            setupEventListeners();
            
            // Apply initial theme
            const prefersDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const iconContainer = dom.themeToggleButton;
            const icon = iconContainer ? iconContainer.querySelector('i') : null;

            if (prefersDark) {
                document.documentElement.classList.add('dark-theme');
                if (icon) icon.setAttribute('data-lucide', 'moon');
            } else {
                document.documentElement.classList.remove('dark-theme');
                if (icon) icon.setAttribute('data-lucide', 'sun');
            }
            
            // Apply initial sidebar state
            const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isSidebarCollapsed) {
                toggleDesktopSidebar(true);
            }

            applyFiltersAndRender();

            setDashboardLoading(false);
            dom.loadingOverlay.classList.remove('show');
        }, 1000);
    };

    init();
});
</script>
</body>
</html>